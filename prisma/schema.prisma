// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum CustomerStatus {
  active
  pending
}

enum ProductCategory {
  Yogurt
  Drink
  Ice_Cream
  Dessert
  Curd
  Other
}

enum UserRole {
  admin
  cashier
}

enum SaleType {
  retail
  wholesale
}

enum SaleStatus {
  completed
  pending
  cancelled
}

enum ReturnLineType {
  returned
  exchanged
}

enum StockTransactionType {
  ADD_STOCK_INVENTORY
  LOAD_TO_VEHICLE
  UNLOAD_FROM_VEHICLE
  REMOVE_STOCK_WASTAGE
  STOCK_ADJUSTMENT_MANUAL
  ISSUE_SAMPLE
}

model Customer {
  id        String         @id
  avatar    String?
  name      String
  phone     String
  address   String?
  shopName  String?        @map("shop_name")
  status    CustomerStatus @default(active)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @default(now()) @map("updated_at")
  sales     Sale[]
  returns   Return[]

  @@index([status], map: "customers_status_idx")
  @@map("customers")
}

model Expense {
  id          String   @id
  category    String
  description String?
  amount      Decimal  @db.Decimal(12, 2)
  expenseDate DateTime @map("expense_date")
  staffId     String?  @map("staff_id")
  vehicleId   String?  @map("vehicle_id")
  createdAt   DateTime @default(now()) @map("created_at")

  staff       User?    @relation(fields: [staffId], references: [id], onDelete: SetNull)
  vehicle     Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([expenseDate], map: "expenses_expense_date_idx")
  @@index([category], map: "expenses_category_idx")
  @@index([staffId], map: "expenses_staff_id_idx")
  @@index([vehicleId], map: "expenses_vehicle_id_idx")
  @@map("expenses")
}

model Product {
  id                String             @id
  name              String
  category          ProductCategory
  sku               String?
  description       String?
  price             Decimal            @db.Decimal(12, 2)
  wholesalePrice    Decimal?           @map("wholesale_price") @db.Decimal(12, 2)
  stock             Int                @default(0)
  reorderLevel      Int?               @map("reorder_level")
  imageUrl          String?            @map("image_url")
  aiHint            String?            @map("ai_hint")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @default(now()) @map("updated_at")
  saleItems         SaleItem[]
  returnItems       ReturnItem[]
  stockTransactions StockTransaction[]

  @@index([sku], map: "products_sku_idx")
  @@index([category], map: "products_category_idx")
  @@index([stock], map: "products_stock_idx")
  @@map("products")
}

model Vehicle {
  id                String             @id
  vehicleNumber     String             @map("vehicle_number")
  driverName        String?            @map("driver_name")
  notes             String?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @default(now()) @map("updated_at")
  sales             Sale[]
  expenses          Expense[]
  stockTransactions StockTransaction[]

  @@unique([vehicleNumber], map: "vehicles_vehicle_number_unique_idx")
  @@index([vehicleNumber], map: "vehicles_vehicle_number_idx")
  @@map("vehicles")
}

model User {
  id                String             @id
  username          String             @unique(map: "users_username_unique_idx")
  name              String
  role              UserRole
  passwordHash      String?            @map("password_hash") // store only hashed passwords
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @default(now()) @map("updated_at")
  sales             Sale[]
  returns           Return[]
  expenses          Expense[]
  stockTransactions StockTransaction[]

  @@map("users")
}

model Sale {
  id String @id

  // Timestamps
  saleDate  DateTime @map("sale_date")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  // Customer snapshot + optional relation
  customerId       String?   @map("customer_id")
  customerName     String?   @map("customer_name")
  customerShopName String?   @map("customer_shop_name")
  customer         Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Staff snapshot + optional relation
  staffId   String? @map("staff_id")
  staffName String? @map("staff_name")
  staff     User?   @relation(fields: [staffId], references: [id], onDelete: SetNull)

  // Vehicle relation (optional)
  vehicleId String?  @map("vehicle_id")
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  // Amounts
  subTotal           Decimal @map("sub_total") @db.Decimal(12, 2)
  discountPercentage Decimal @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  discountAmount     Decimal @default(0) @map("discount_amount") @db.Decimal(12, 2)
  totalAmount        Decimal @map("total_amount") @db.Decimal(12, 2)

  // Payments summary (Firebase style)
  paidAmountCash         Decimal? @map("paid_amount_cash") @db.Decimal(12, 2)
  paidAmountCheque       Decimal? @map("paid_amount_cheque") @db.Decimal(12, 2)
  paidAmountBankTransfer Decimal? @map("paid_amount_bank_transfer") @db.Decimal(12, 2)
  creditUsed             Decimal? @map("credit_used") @db.Decimal(12, 2)

  totalAmountPaid    Decimal @default(0) @map("total_amount_paid") @db.Decimal(12, 2)
  outstandingBalance Decimal @default(0) @map("outstanding_balance") @db.Decimal(12, 2)

  paymentSummary String? @map("payment_summary")

  // Offer / status
  offerApplied Boolean    @default(false) @map("offer_applied")
  status       SaleStatus @default(completed)

  // Relations
  items   SaleItem[]
  returns Return[]

  @@index([saleDate], map: "sales_sale_date_idx")
  @@index([customerId], map: "sales_customer_id_idx")
  @@index([staffId], map: "sales_staff_id_idx")
  @@index([vehicleId], map: "sales_vehicle_id_idx")
  @@map("sales")
}

model SaleItem {
  id String @id

  saleId String @map("sale_id")
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  quantity     Int
  appliedPrice Decimal  @map("applied_price") @db.Decimal(12, 2)
  saleType     SaleType @map("sale_type")
  isOfferItem  Boolean  @default(false) @map("is_offer_item")

  // Snapshot fields from Firebase item
  productName     String?  @map("product_name")
  productCategory String?  @map("product_category")
  productPrice    Decimal? @map("product_price") @db.Decimal(12, 2)
  productSku      String?  @map("product_sku")
  productRef      String?  @map("product_ref")

  @@index([saleId], map: "sale_items_sale_id_idx")
  @@index([productId], map: "sale_items_product_id_idx")
  @@map("sale_items")
}

model Return {
  id String @id

  createdAt  DateTime @default(now()) @map("created_at")
  returnDate DateTime @map("return_date")

  // Link to original sale
  originalSaleId String? @map("original_sale_id")
  originalSale   Sale?   @relation(fields: [originalSaleId], references: [id], onDelete: SetNull)

  // Customer snapshot + optional relation
  customerId       String?   @map("customer_id")
  customerName     String?   @map("customer_name")
  customerShopName String?   @map("customer_shop_name")
  customer         Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Staff snapshot + optional relation
  staffId   String? @map("staff_id")
  staffName String? @map("staff_name")
  staff     User?   @relation(fields: [staffId], references: [id], onDelete: SetNull)

  items ReturnItem[]

  @@index([returnDate], map: "returns_return_date_idx")
  @@index([originalSaleId], map: "returns_original_sale_id_idx")
  @@index([customerId], map: "returns_customer_id_idx")
  @@index([staffId], map: "returns_staff_id_idx")
  @@map("returns")
}

model ReturnItem {
  id String @id

  returnId String @map("return_id")
  return   Return @relation(fields: [returnId], references: [id], onDelete: Cascade)

  lineType ReturnLineType @map("line_type") // returned | exchanged

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  quantity     Int
  appliedPrice Decimal  @map("applied_price") @db.Decimal(12, 2)
  saleType     SaleType @map("sale_type")
  isOfferItem  Boolean  @default(false) @map("is_offer_item")

  // Snapshot fields from Firebase
  productName     String?  @map("product_name")
  productCategory String?  @map("product_category")
  productPrice    Decimal? @map("product_price") @db.Decimal(12, 2)
  productSku      String?  @map("product_sku")
  productRef      String?  @map("product_ref")

  @@index([returnId], map: "return_items_return_id_idx")
  @@index([productId], map: "return_items_product_id_idx")
  @@index([lineType], map: "return_items_line_type_idx")
  @@map("return_items")
}

model StockTransaction {
  id String @id

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Snapshot fields (keep history even if product changes)
  productName String? @map("product_name")
  productSku  String? @map("product_sku")

  type          StockTransactionType
  quantity      Int
  previousStock Int                  @map("previous_stock")
  newStock      Int                  @map("new_stock")

  transactionDate DateTime @map("transaction_date")
  notes           String?

  vehicleId String?  @map("vehicle_id")
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

  @@index([transactionDate], map: "stock_transactions_transaction_date_idx")
  @@index([productId], map: "stock_transactions_product_id_idx")
  @@index([type], map: "stock_transactions_type_idx")
  @@index([vehicleId], map: "stock_transactions_vehicle_id_idx")
  @@index([userId], map: "stock_transactions_user_id_idx")
  @@map("stock_transactions")
}
